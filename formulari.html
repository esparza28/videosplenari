<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Formulari Ple Municial Gandia</title>
    <meta name="keywords" content="" />
    <meta name="description" content="">
    <meta name="author" content="caca.net">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, shrink-to-fit=no">
    <link rel="shortcut icon" href="" type="image/x-icon" />

    <link id="googleFonts" href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700&display=swap"
        rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="css/custom.css">

</head>

<body>
    <div class="container">
        <h1 class="text-center p-2">Sessió parlamentaria</h1>
        <form id="myForm" onsubmit='return get()'>
            <div class="row col-sm" id="input_fields_wrap">
                <div class="d-flex">
                    <label class="form-group p-1" for="url">URL youtube: </label>
                    <input class="form-group col col-md-6 m-1" type="url" accept="text/plain" name="url"
                        class="form-control" id="url" placeholder="Ex. https://www.youtube.com/watch?v=ShDXPTN4jS8"
                        required>
                </div>
                <div>
                    <label class="form-group col" for="url">Fitxer de la sessió: </label>
                    <input class="form-group col m-1" type="file" name="file" class="form-control" id="file"
                        accept=".txt, .csv" required disabled>
                </div>

                <label class="form-group col-md-6" for="punt">Punt del dia</label>
                <label class="form-group col-md-6" for="time">Temps (hh:mm:ss)</label>
                <div class="form-group row" id="divPunts">
                    <input class="form-group col m-1" type="text" name="punt" class="form-control" id="punt0"
                        placeholder="Ex. Rebaixada de sous dels regidors." required>
                    <input class="form-group col m-1" type="text" name="punt" class="form-control" id="time0"
                        placeholder="Ex. 00:02:05" required>
                    <button class="col-1 btn btn-outline-danger p-0 btn-sm" id="remove_field">
                        <i class="fas fa-minus-circle"></i>Eliminar
                    </button>
                </div>
            </div>
            <div class="row justify-content-end">
                <button class="col-1 btn btn-outline-success my-2" id="add_button"><i
                        class="fas fa-plus-circle"></i>Afegir
                </button>
            </div>

            <div class="row">
                <button class="btn btn-outline-primary btn-sm" type="submit">Registrar</button>
            </div>
        </form>
    </div>

    <!-- Theme Custom -->
    <script type="text/javascript" src="js/custom.js"></script>
    <script type="text/javascript" src="js/filesaver.js"></script>

    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>

    <script>
        var max_fields = 10; //maximum input boxes allowed
        var wrapper = $("#input_fields_wrap"); //Fields wrapper
        var add_button = $("#add_button"); //Add button ID
        var array = [];

        var x = 1; //initlal text box count
        $(add_button).click(function (e) { //on add input button click
            e.preventDefault();
            if (x < max_fields) { //max input box allowed
                x++; //text box increment
                $(wrapper).append(
                    '<div class="form-group row">' +
                    '<input class="form-group col m-1" type="text" name="punt" class="form-control" id="punt' + (x - 1) + '" placeholder="Ex. Rebaixada de sous dels regidors." required> ' +
                    '<input class="form-group col m-1" type="text" name="punt" class="form-control" id="time' + (x - 1) + '" placeholder="Ex. 00:02:05" required> ' +
                    '<button class="col-1 btn btn-outline-danger my-2" id="remove_field"><i class="fas fa-minus-circle"></i>Eliminar</button></div>'
                ); //add input box
            }
        });

        //user click on remove text
        $(wrapper).on("click", "#remove_field", function (e) {
            e.preventDefault(); $(this).parent('div').remove(); x--;
        });

        $('#url').on('input', function(){
            if($(this).val()){
                $('#file').prop('disabled', false);
            }else{
                $('#file').prop('disabled', true);
            }
        })

        $('#file').on('change', function () {
        //function getFile() {
            var file = $('#file')[0].files[0];
            var fileReader = new FileReader();
            fileReader.readAsText(file);
            fileReader.onload = function () {
                var txt = fileReader.result;
                var lines = txt.toString().split("\n");
                var lines = txt.toString().split("\r");
                var headers = lines[0].split(";");

                //convert from txt to json file
                var result = [];
                var frames = [];
                for (let i = 1; i < lines.length; i++) {
                    var obj = {};
                    var currentline = lines[i].split(";");

                    for (let j = 0; j < headers.length; j++) {
                        obj[headers[j]] = currentline[j];
                    }
                    result.push(obj);
                }
                let jsonString = JSON.stringify(result);
                let json = JSON.parse(jsonString);

                //url generator with time, url and speaker 
                for (let i = 0; i < lines.length - 1; i++) {
                    var url = {};
                    let time = json[i]['00:00:00'];
                    url['url'] = urlWithSecs(document.getElementById('url').value, time);

                    var speak = 'silencio';
                    for (let j = 0; j < headers.length; j++) {
                        if (json[i]['AUDIO ' + j] === 'HABLA') {
                            speak = j;
                            break;
                        }
                    }
                    url['speaker'] = speak;
                    frames.push(url);
                }
                let ob = {};
                ob['links'] = frames;
                array.push(ob);
            }
            console.log(array);
        })

        //generar json desde form
        function get() {
            var form = document.getElementById('myForm');
            let punts = [];

            for (var i = 0; i < document.getElementsByName('punt').length / 2; i++) {
                let obj = {};
                let puntname = '#punt' + i;
                let timename = '#time' + i;
                var punt = document.querySelector(puntname);
                var time = document.querySelector(timename);

                obj['punt'] = i;
                obj['title'] = punt.value;
                obj['time'] = time.value;
                obj['url'] = urlWithSecs(document.getElementById('url').value, time.value);

                punts.push(obj);
            }
            let ob = {};
            ob['puntsDia'] = punts;
            array.push(ob);

            let jsonString = JSON.stringify(array);
            let json = JSON.parse(jsonString);

            //guardar com a fitxer
            jsonName = 'Plenari_' + formatDate(new Date());;
            var blob = new Blob([jsonString],
                { type: "text/plain;charset=utf-8" });
            saveAs(blob, jsonName + ".json");

            return false;
        }

        function formatDate(date) {
            return date.getDate() +
                "/" + (date.getMonth() + 1) +
                "/" + date.getFullYear() +
                "_" + date.getHours() +
                ":" + date.getMinutes() +
                ":" + date.getSeconds();
        }

        function urlWithSecs(url, time) {
            var d = new Date("0001-01-01T" + time);
            var seconds = d.getHours() * 120 + d.getMinutes() * 60 + d.getSeconds();
            return url + "&t=" + seconds + "s";
        }

    </script>
</body>

</html>